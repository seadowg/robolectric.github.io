<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Robolectric</title>
    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(["_setAccount", "UA-19269905-1"]);
  _gaq.push(["_trackPageview"]);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
    <link href="../images/favicon-6cf12dec.png" rel="icon" type="image/png" />
    <link href="../stylesheets/application-5b0d8697.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="../javascripts/application-da39a3ee.js" type="text/javascript"></script>
</head>

<body>
    <div id="wrapper">
        <div id="header">
            <ul class="nav navbar-nav pull-right">
    <li>
        <a href='http://robolectric.blogspot.com'>
            <i class='glyphicon glyphicon-book'></i>
            <span>Blog</span>
        </a>
    </li>
    <li>
        <a href='http://groups.google.com/group/robolectric'>
            <i class='glyphicon glyphicon-envelope'></i>
            <span>Mailing List</span>
        </a>
    </li>
    <li>
        <a href='/javadoc/index.html?overview-summary.html'>
            <i class='glyphicon glyphicon-cog'></i>
            <span>API Docs</span>
        </a>
    </li>
</ul>
        </div>

        <div id="sidebar">
            <a href="/"><img class="logo" src="../images/robolectric-7fb6698b.png" /></a><ul class='nav nav-stacked'><li class='nav-header'>Setup</li><li class='nav-item'><a href='/installation/'>Installation</a></li><li class='nav-item'><a href='/quick-start/'>Quick Start</a></li><li class='nav-item'><a href='/eclipse-quick-start/'>Eclipse Quick Start</a></li><li class='nav-item'><a href='/download/'>Downloads</a></li></ul><ul class='nav nav-stacked'><li class='nav-header'>User Guide</li><li class='nav-item'><a href='/getting-started/'>Getting Started</a></li><li class='nav-item'><a href='/starting-components/'>Starting Other Components</a></li><li class='nav-item'><a href='/activity-lifecycle/'>Driving the Activity Lifecycle</a></li><li class='nav-item'><a href='/custom-shadows/'>Creating Custom Shadows</a></li><li class='nav-item'><a href='/apklibs/'>Working with ApkLibs</a></li><li class='nav-item'><a href='/resource-qualifiers/'>Using Qualified Resources</a></li></ul><ul class='nav nav-stacked'><li class='nav-header'>Customizing</li><li class='nav-item'><a href='/extending/'>Extending Robolectric</a></li><li class='nav-item'><a href='/custom-test-runner/'>Custom the Test Runner</a></li><li class='nav-item'><a href='/roboguice/'>Integrating with RoboGuice</a></li></ul><ul class='nav nav-stacked'><li class='nav-header'>Contributing</li><li class='nav-item'><a href='/contributor-guidelines/'>Contributor Guidelines</a></li><li class='nav-item'><a href='/release-notes/'>Release Notes</a></li><li class='nav-item'><a href='/android-jars/'>Real Android JARs</a></li><li class='nav-item'><a href='/resources/'>Other Resources</a></li></ul>
        </div>

        <div id="content">
            <h1>Integrating with RoboGuice</h1>

<p>The <a href="https://github.com/robolectric/RobolectricSample">RobolectricSample application</a> includes an
example of how to test Android applications that are built using the <a href="http://code.google.com/p/roboguice/">RoboGuice</a>
dependency injection framework. This article explains what we did and how you can add RoboGuice to your own projects.</p>

<h2>The Sample Activity</h2>

<p>For the most part RoboGuice will just work when injected instances of classes are exercised by unit tests, but with a
little bit of work can inject those instances directly into our tests. As an example, we can start with this simple
activity:</p>
<pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectedActivity</span> <span class="kd">extends</span> <span class="n">GuiceActivity</span> <span class="o">{</span>
    <span class="nd">@InjectResource</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">injected_activity_caption</span><span class="o">)</span> <span class="n">String</span> <span class="n">caption</span><span class="o">;</span>
    <span class="nd">@InjectView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">injected_text_view</span><span class="o">)</span> <span class="n">TextView</span> <span class="n">injectedTextView</span><span class="o">;</span>

    <span class="nd">@Override</span> <span class="kd">protected</span> <span class="kt">void</span> <span class="n">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">injected</span><span class="o">);</span>
        <span class="n">injectedTextView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">caption</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre>
<p>To get this to work you need to change your manifest to point to <code>roboguice.application.GuiceApplication</code>
(or a subclass) and link with the RoboGuice library. We wrote the following test:</p>
<pre class="highlight java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldAssignStringToTextView</span><span class="p">(</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">injectedActivity</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="n">TextView</span> <span class="n">injectedTextView</span> <span class="o">=</span>
        <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">injectedActivity</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">injected_text_view</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">injectedTextView</span><span class="o">.</span><span class="na">getText</span><span class="o">(),</span> <span class="n">caption</span><span class="o">);</span>
<span class="o">}</span>
</pre>
<p>This test passes but the set up for it is ugly:</p>
<pre class="highlight java"><span class="n">InjectedActivity</span> <span class="n">injectedActivity</span><span class="o">;</span>
<span class="n">String</span> <span class="n">caption</span><span class="o">;</span>
<span class="nd">@Before</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="p">(</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">injectedActivity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InjectedActivity</span><span class="o">();</span>
    <span class="n">Resources</span> <span class="n">resources</span> <span class="o">=</span> <span class="n">injectedActivity</span><span class="o">.</span><span class="na">getResources</span><span class="o">();</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">injected_activity_caption</span><span class="o">);</span>
<span class="o">}</span>
</pre>
<h2>Injecting Tests</h2>

<p>With some changes to the test runner we can make it look like this:</p>
<pre class="highlight java">    <span class="nd">@Inject</span> <span class="n">InjectedActivity</span> <span class="n">injectedActivity</span><span class="o">;</span>
    <span class="nd">@InjectResource</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">injected_activity_caption</span><span class="o">)</span> <span class="n">String</span> <span class="n">caption</span><span class="o">;</span>
</pre>
<p>In <code>RobolectricSample</code> we created a subclass of <code>RobolectricTestRunner</code> called <code>InjectedTestRunner</code> and extended it
to ensure that instances of the test class were injected before the tests were run. <code>RobolectricTestRunner</code> has a
method called <code>prepareTest(Test test)</code> that exists for the purpose of giving its subclasses access to the <code>Test</code>
object just before each test. It can be used for injection as follows:</p>
<pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectedTestRunner</span> <span class="kd">extends</span> <span class="n">RobolectricTestRunner</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">InjectedTestRunner</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">testClass</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InitializationError</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">testClass</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="n">prepareTest</span><span class="o">(</span><span class="n">Object</span> <span class="n">test</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">GuiceApplication</span> <span class="n">sampleApplication</span> <span class="o">=</span> <span class="o">(</span><span class="n">GuiceApplication</span><span class="o">)</span> <span class="n">Robolectric</span><span class="o">.</span><span class="na">application</span><span class="o">;</span>
        <span class="n">Injector</span> <span class="n">injector</span> <span class="o">=</span> <span class="n">sampleApplication</span><span class="o">.</span><span class="na">getInjector</span><span class="o">();</span>
        <span class="n">injector</span><span class="o">.</span><span class="na">injectMembers</span><span class="o">(</span><span class="n">test</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre>
<p>It can be used in a <code>@RunWith</code> clause instead of <code>RobolectricTestRunner</code>:</p>
<pre class="highlight java"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">InjectedTestRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectedActivityTest</span> <span class="o">{</span>
<span class="o">...</span>
<span class="o">}</span>
</pre>
<h2>Injecting Context Objects onto Tests</h2>

<p>There are some types, such as <code>Context</code>s that RoboGuice can&rsquo;t inject without entering the context scope in the test
runner&rsquo;s <code>prepareTest()</code> method:</p>
<pre class="highlight java"><span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="n">prepareTest</span><span class="o">(</span><span class="n">Object</span> <span class="n">test</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">GuiceApplication</span> <span class="n">sampleApplication</span> <span class="o">=</span> <span class="o">(</span><span class="n">GuiceApplication</span><span class="o">)</span> <span class="n">Robolectric</span><span class="o">.</span><span class="na">application</span><span class="o">;</span>
    <span class="n">Injector</span> <span class="n">injector</span> <span class="o">=</span> <span class="n">sampleApplication</span><span class="o">.</span><span class="na">getInjector</span><span class="o">();</span>
    <span class="n">ContextScope</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">ContextScope</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">scope</span><span class="o">.</span><span class="na">enter</span><span class="o">(</span><span class="n">sampleApplication</span><span class="o">);</span>
    <span class="n">injector</span><span class="o">.</span><span class="na">injectMembers</span><span class="o">(</span><span class="n">test</span><span class="o">);</span>
<span class="o">}</span>
</pre>
<p>Now it is possible to inject a <code>Context</code> object onto the test:</p>
<pre class="highlight java"><span class="nd">@Inject</span> <span class="n">Context</span> <span class="n">context</span><span class="o">;</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldBeAbleToInjectAContext</span><span class="p">(</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">assertNotNull</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
<span class="o">}</span>
</pre>
<h2>Test-only Bindings</h2>

<p>During test it can be useful to use fake objects that produce well-known values in order to simplify assertions. Below
is an example of a fake <code>Provider&amp;lt;Date&amp;gt;</code>.</p>
<pre class="highlight java"><span class="cm">/* bound as singleton so tests will get the same provider as the production code */</span>
<span class="nd">@Singleton</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FakeDateProvider</span> <span class="kd">implements</span> <span class="n">Provider</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">();</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Date</span> <span class="n">get</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">date</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="n">setDate</span><span class="o">(</span><span class="n">String</span> <span class="n">dateString</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre>
<h2>Defining and Inserting a Test Module</h2>

<p>A test module contains the bindings for our fake date provider.</p>
<pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RobolectricSampleTestModule</span> <span class="kd">extends</span> <span class="n">AbstractAndroidModule</span> <span class="o">{</span>
    <span class="nd">@Override</span> <span class="kd">protected</span> <span class="kt">void</span> <span class="n">configure</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">bind</span><span class="o">(</span><span class="n">Counter</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">in</span><span class="o">(</span><span class="n">Scopes</span><span class="o">.</span><span class="na">SINGLETON</span><span class="o">);</span>
        <span class="n">bind</span><span class="o">(</span><span class="n">Date</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">toProvider</span><span class="o">(</span><span class="n">FakeDateProvider</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre>
<p>Create a new subclass of <code>GuiceApplication</code> that contributes your project&rsquo;s modules to the standard
Android modules that will be injected:</p>
<pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleGuiceApplication</span> <span class="kd">extends</span> <span class="n">GuiceApplication</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Module</span> <span class="n">module</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RobolectricSampleModule</span><span class="o">();</span>

    <span class="nd">@Override</span> <span class="kd">protected</span> <span class="kt">void</span> <span class="n">addApplicationModules</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Module</span><span class="o">&gt;</span> <span class="n">modules</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">modules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">module</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre>
<p>Add a new setter method so that a test module can be used instead:</p>
<pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleGuiceApplication</span> <span class="kd">extends</span> <span class="n">GuiceApplication</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">setModule</span><span class="o">(</span><span class="n">Module</span> <span class="n">module</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre>
<p>Override the production module with a test module in the test runner, like this:</p>
<pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectedTestRunner</span> <span class="kd">extends</span> <span class="n">RobolectricTestRunner</span> <span class="o">{</span>
   <span class="o">...</span>
   <span class="nd">@Override</span> <span class="kd">protected</span> <span class="n">Application</span> <span class="n">createApplication</span><span class="o">()</span> <span class="o">{</span>
       <span class="n">SampleGuiceApplication</span> <span class="n">application</span> <span class="o">=</span>
           <span class="o">(</span><span class="n">SampleGuiceApplication</span><span class="o">)</span> <span class="kd">super</span><span class="o">.</span><span class="na">createApplication</span><span class="o">();</span>
       <span class="n">application</span><span class="o">.</span><span class="na">setModule</span><span class="o">(</span><span class="k">new</span> <span class="n">RobolectricSampleTestModule</span><span class="o">());</span>

       <span class="k">return</span> <span class="n">application</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="o">...</span>
<span class="o">}</span>
</pre>
<h2>Using the New Bindings</h2>

<p>To take advantage of the bindings created for test, the production code needs to inject a <code>Date</code> instead of
instantiating one itself.</p>
<pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectedActivity</span> <span class="kd">extends</span> <span class="n">GuiceActivity</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="n">DateFormat</span> <span class="n">dateFormat</span> <span class="o">=</span> <span class="n">DateFormat</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>

    <span class="nd">@Inject</span> <span class="n">Date</span> <span class="n">date</span><span class="o">;</span>

    <span class="nd">@Override</span> <span class="kd">protected</span> <span class="kt">void</span> <span class="n">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="n">injectedTextView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">caption</span> <span class="o">+</span> <span class="s">" - "</span> <span class="o">+</span> <span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">date</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre>
<p>The FakeDateProvider can then be injected into the test and used to set injected dates to a well-known value
that can be asserted:</p>
<pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InjectedActivityTest</span> <span class="o">{</span>
    <span class="nd">@Inject</span> <span class="n">FakeDateProvider</span> <span class="n">fakeDateProvider</span><span class="o">;</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">setUp</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">fakeDateProvider</span><span class="o">.</span><span class="na">setDate</span><span class="o">(</span><span class="s">"Dec 8, 2010"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">shouldAssignStringToTextView</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">injectedActivity</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">TextView</span> <span class="n">injectedTextView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">injectedActivity</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">injected_text_view</span><span class="o">);</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">injectedTextView</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span>
                <span class="n">equalTo</span><span class="o">(</span><span class="s">"Roboguice Activity tested with Robolectric - Dec 8, 2010"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre>
        </div>
    </div>

    <div id="footer">
        
    </div>
</body>
</html>